<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Busz játék - Piramis</title>
    <style>
        body { font-family: Arial, sans-serif; background: #2e7d32; margin: 0; }
        .container { max-width: 1400px; margin: 30px auto; background: #388e3c; padding: 24px; border-radius: 30px; box-shadow: 0 2px 16px #222; }
        h1 { text-align: center; color: #fff; margin-bottom: 10px; }
        .table {
            position: relative;
            width: 1200px;
            height: 900px;
            margin: 0 auto;
            background: radial-gradient(ellipse at center, #43a047 80%, #1b5e20 100%);
            border-radius: 50%;
            box-shadow: 0 0 40px #222 inset;
            overflow: visible;
        }
        .pyramid {
            position: absolute;
            left: 50%;
            top: 120px;
            transform: translateX(-50%);
            z-index: 2;
            width: 500px;
        }
        .row {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        .card {
            width: 70px;
            height: 105px;
            margin: 6px;
            border-radius: 10px;
            box-shadow: 0 2px 8px #222;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
            position: relative;
        }
        .card .suit {
            font-size: 28px;
            margin-bottom: 2px;
        }
        .card .rank {
            font-size: 24px;
            font-weight: bold;
        }
        .card.active { background: #ffe082; border: 2px solid #fbc02d; }
        .card.hidden { background: #263238; color: #263238; }
        .card.used { opacity: 0.3; pointer-events: none; }
        .player-area {
            position: absolute;
            width: 220px;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 10px;
            z-index: 3;
        }
        .player-label {
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px #222;
            font-size: 20px;
        }
        .hand {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .hand .card.used { display: none; }
        .player0 { left: 300px; top: 780px; transform: none; }
        .player1 { left: 1080px; top: 670px; }
        .player2 { left: 1080px; top: 270px; }
        .player3 { left: 50%; top: 10px; transform: translate(-50%, 0); display:none; }
        .player4 { left: 0px; top: 270px; }
        .player5 { left: 0px; top: 670px; }
        .btn-bar {
            text-align: center;
            margin: 12px 0 0 0;
        }
        .btn {
            padding: 10px 24px;
            margin: 8px 4px;
            border-radius: 10px;
            border: none;
            background: #fbc02d;
            color: #222;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 6px #222;
            transition: background 0.2s;
        }
        .btn:disabled { background: #aaa; cursor: not-allowed; }
        .info {
            margin: 18px 0 0 0;
            font-weight: bold;
            color: #fff;
            text-align: center;
            text-shadow: 1px 1px 2px #222;
            font-size: 20px;
        }
        .busz-area {
            position: absolute;
            left: 50%;
            top: 200px;
            transform: translateX(-50%);
            width: 600px;
            z-index: 10;
            background: rgba(56,142,60,0.95);
            border-radius: 20px;
            padding: 24px 0 16px 0;
            box-shadow: 0 2px 16px #222;
        }
        .busz-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 18px;
        }
        .busz-btns {
            text-align: center;
            margin-top: 10px;
        }
        .busz-history {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .busz-next {
            text-align: center;
            margin-top: 18px;
            font-size: 22px;
            color: #fff;
            font-weight: bold;
        }
        @media (max-width: 1400px) {
            .container, .table { width: 98vw; }
        }
        @media (max-width: 1200px) {
            .table { width: 98vw; height: 80vw; min-height: 500px; }
            .player-area { width: 140px; height: 100px; }
            .card { width: 45px; height: 70px; font-size: 14px; }
            .pyramid { width: 300px; }
            .busz-area { width: 98vw; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Busz játék - Piramis</h1>
    <div class="table" id="table">
        <!-- Dinamikus tartalom -->
    </div>
    <div class="btn-bar">
        <button class="btn" onclick="startGame()">Új játék</button>
    </div>
    <div class="info" id="info"></div>
</div>
<script>
const SUITS = [
    {name: 'kör', symbol: '♥', color: 'red'},
    {name: 'pikk', symbol: '♠', color: 'black'},
    {name: 'káró', symbol: '♦', color: 'red'},
    {name: 'treff', symbol: '♣', color: 'black'}
];
const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
const RANK_VALUES = {};
RANKS.forEach((r, i) => RANK_VALUES[r] = i + 2);

let playerNames = [];

function createDeck() {
    let deck = [];
    for (let s of SUITS) {
        for (let r of RANKS) {
            deck.push({suit: s.name, symbol: s.symbol, color: s.color, rank: r});
        }
    }
    return deck;
}
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}
function buildPyramid(deck) {
    let pyramid = [];
    let idx = 0;
    for (let rowLen = 5; rowLen > 0; rowLen--) {
        let row = [];
        for (let i = 0; i < rowLen; i++) {
            row.push(deck[idx++]);
        }
        pyramid.push(row);
    }
    return [pyramid, deck.slice(idx)];
}
function dealHands(deck, numPlayers, cardsPerPlayer=5) {
    let hands = [];
    let idx = 0;
    for (let i = 0; i < numPlayers; i++) {
        hands.push(deck.slice(idx, idx + cardsPerPlayer));
        idx += cardsPerPlayer;
    }
    return [hands, deck.slice(idx)];
}
function printCard(card) {
    return `<span class="suit" style="color:${card.color}">${card.symbol}</span>
            <span class="rank">${card.rank}</span>`;
}

// --- Játék logika ---
let state = {
    numPlayers: 0,
    pyramid: [],
    deck: [],
    hands: [],
    currentRow: 0,
    currentCard: 0,
    info: "",
    busPlayers: [],
    buszActive: false,
    buszIndex: 0,
    buszTry: 0,
    buszCards: [],
    buszStep: 0,
    usedPyramid: [],
    usedHands: [],
    buszHistory: [],
    buszCurrentCard: null,
    buszNextDraw: null
};

function askPlayerNames(numPlayers) {
    playerNames = [];
    for (let i = 0; i < numPlayers; i++) {
        let name = prompt(`Add meg a(z) ${i+1}. játékos nevét:`);
        if (!name || name.trim() === "") name = `Játékos ${i+1}`;
        playerNames.push(name.trim());
    }
}

function startGame() {
    let numPlayers = parseInt(prompt("Hány játékos? (2-6)"));
    if (isNaN(numPlayers) || numPlayers < 2 || numPlayers > 6) {
        alert("2-6 játékos lehet!");
        return;
    }
    askPlayerNames(numPlayers);
    let deck = createDeck();
    shuffle(deck);
    let [pyramid, deck2] = buildPyramid(deck);
    let [hands, deck3] = dealHands(deck2, numPlayers);
    state = {
        numPlayers,
        pyramid,
        deck: deck3,
        hands,
        currentRow: 0,
        currentCard: 0,
        info: "",
        busPlayers: [],
        buszActive: false,
        buszIndex: 0,
        buszTry: 0,
        buszCards: [],
        buszStep: 0,
        usedPyramid: Array.from({length: pyramid.length}, (_, i) => Array(pyramid[i].length).fill(false)),
        usedHands: Array.from({length: numPlayers}, () => []),
        buszHistory: [],
        buszCurrentCard: null,
        buszNextDraw: null
    };
    render();
}

function nextPyramidCard() {
    let row = state.pyramid[state.currentRow];
    let currentCardObj = row[state.currentCard];
    state.usedPyramid[state.currentRow][state.currentCard] = true;

    // Szám alapú duplikáció keresés (csak rank, suit nem számít)
    let count = 0;
    for (let r = 0; r < state.pyramid.length; r++) {
        for (let c = 0; c < state.pyramid[r].length; c++) {
            let card = state.pyramid[r][c];
            if (card.rank === currentCardObj.rank) {
                count++;
            }
        }
    }
    // Minden új lap után kiírjuk, kinek kell innia és mennyit
    let kortyInfo = "";
    if (count > 1) {
        kortyInfo = `Ez a szám (${currentCardObj.rank}) ${count}x szerepel a piramisban! Mindenki iszik ${state.currentRow + 1} kortyot!`;
    }

    // Töröljük a játékosok kezéből azokat a lapokat, amik már szerepeltek a piramisban (csak szám alapján)
    for (let i = 0; i < state.hands.length; i++) {
        state.hands[i] = state.hands[i].filter(card =>
            !isRankInPyramid(card.rank, state.usedPyramid, state.pyramid)
        );
    }

    // Kiírjuk, kinek kell innia (akinek ilyen számú lapja volt)
    let ivok = [];
    for (let i = 0; i < state.usedHands.length; i++) {
        let used = state.usedHands[i].filter(card => card.rank === currentCardObj.rank);
        if (used.length > 0) ivok.push(playerNames[i]);
    }
    if (ivok.length > 0) {
        kortyInfo += `<br>${ivok.join(', ')} iszik ${state.currentRow + 1} kortyot!`;
    }

    state.info = kortyInfo;

    state.currentCard++;
    if (state.currentCard >= row.length) {
        state.currentRow++;
        state.currentCard = 0;
        if (state.currentRow >= state.pyramid.length) {
            // vége a piramisnak, buszra szállás
            let maxLeft = Math.max(...state.hands.map(h => h.length));
            state.busPlayers = [];
            state.hands.forEach((h, i) => {
                if (h.length === maxLeft) state.busPlayers.push(i);
            });
            let busNames = state.busPlayers.map(i => playerNames[i]);
            state.info = busNames.length === 1 ?
                `A legtöbb kártyával maradt játékos: ${busNames[0]} (Buszra száll!)` :
                `A legtöbb kártyával maradt játékosok: ${busNames.join(', ')} (Buszra szállnak!)`;
            state.buszActive = true;
            state.buszIndex = 0;
            state.buszTry = 0;
            startBusz();
            return;
        }
    }
    render();
}

function isRankInPyramid(rank, usedPyramid, pyramid) {
    for (let r = 0; r < usedPyramid.length; r++) {
        for (let c = 0; c < usedPyramid[r].length; c++) {
            if (usedPyramid[r][c]) {
                let pCard = pyramid[r][c];
                if (rank === pCard.rank) {
                    return true;
                }
            }
        }
    }
    return false;
}

function playPyramidCard(playerIdx, cardIdx) {
    let row = state.pyramid[state.currentRow];
    let card = row[state.currentCard];
    let hand = state.hands[playerIdx];
    let chosen = hand[cardIdx];
    if (chosen.rank !== card.rank) return; // csak azonos számú lapra kattintás engedélyezett
    let drinks = state.currentRow + 1;
    let diff = Math.abs(RANK_VALUES[chosen.rank] - RANK_VALUES[card.rank]);
    if (diff === 0) {
        state.info = `Dupla ivás! ${drinks*2} korty.`;
    } else {
        state.info = `${diff*drinks} korty.`;
    }
    state.usedHands[playerIdx].push(chosen);
    hand.splice(cardIdx, 1);
    nextPyramidCard();
}

function startBusz() {
    if (state.deck.length < 5) {
        state.deck = state.deck.concat(createDeck());
        shuffle(state.deck);
    }
    state.buszCards = state.deck.slice(0,5);
    state.deck = state.deck.slice(5);
    state.buszStep = 0;
    state.buszTry++;
    state.buszHistory = [];
    state.buszCurrentCard = null;
    state.buszNextDraw = null;
    render();
}

function buszGuess(guess) {
    // Első lapnál is tippelni kell!
    if (state.buszCurrentCard === null) {
        state.buszCurrentCard = state.buszCards[state.buszStep];
        // Nincs return, azonnal tippelés!
    }
    if (state.deck.length === 0) {
        state.deck = createDeck();
        shuffle(state.deck);
    }
    let drawn = state.deck.shift();
    state.buszNextDraw = drawn;
    let base = state.buszCurrentCard;

    // HIBA JAVÍTÁS: Mindig a RANKS indexe alapján hasonlítjuk össze a rangokat!
    let baseValue = RANKS.indexOf(base.rank);
    let drawnValue = RANKS.indexOf(drawn.rank);

    let actual;
    if (drawnValue > baseValue) actual = 'm';
    else if (drawnValue < baseValue) actual = 'a';
    else actual = 'u';

    let correct = guess === actual;

    state.buszHistory.push({
        base,
        drawn,
        guess,
        actual,
        correct
    });
    if (!correct) {
        state.info = `Hibás! ${state.buszStep+1} kortyot kell inni. Elölről kezded, új lapokkal!`;
        setTimeout(() => {
            startBusz();
        }, 1200);
        render();
        return;
    } else {
        state.info = "Helyes!";
        state.buszStep++;
        if (state.buszStep >= 5) {
            state.info = "Gratulálok, végigmentél a buszon!";
            setTimeout(() => {
                state.buszIndex++;
                if (state.buszIndex < state.busPlayers.length) {
                    startBusz();
                } else {
                    state.buszActive = false;
                    state.info += " Játék vége!";
                    render();
                }
            }, 1200);
        } else {
            setTimeout(() => {
                state.buszCurrentCard = drawn;
                state.buszNextDraw = null;
                render();
            }, 1200);
        }
    }
    render();
}

function render() {
    let tableDiv = document.getElementById("table");
    let infoDiv = document.getElementById("info");
    let html = "";

    if (!state.buszActive) {
        html += `<div class="pyramid">`;
        state.pyramid.forEach((row, rIdx) => {
            html += `<div class="row">`;
            let pad = (5 - row.length) * 35;
            html += `<div style="width:${pad}px;"></div>`;
            row.forEach((card, cIdx) => {
                let show = (rIdx < state.currentRow) ||
                           (rIdx === state.currentRow && cIdx <= state.currentCard);
                let highlight = (rIdx === state.currentRow && cIdx === state.currentCard);
                let used = state.usedPyramid[rIdx][cIdx];
                html += `<div class="card${show ? (highlight ? " active" : "") : " hidden"}${used ? " used" : ""}">${show ? printCard(card) : "?"}</div>`;
            });
            html += `</div>`;
        });
        html += `</div>`;
        html += `<div style="position:absolute;left:50%;top:97%;transform:translate(-50%,0);z-index:10;">
            <button class="btn" onclick="nextPyramidCard()">Következő kártya</button>
        </div>`;
    }

    if (!state.buszActive) {
        // Gyűjtsük ki a piramisban már szereplő számokat/betűket (rank)
        let usedRanks = new Set();
        for (let r = 0; r < state.usedPyramid.length; r++) {
            for (let c = 0; c < state.usedPyramid[r].length; c++) {
                if (state.usedPyramid[r][c]) {
                    usedRanks.add(state.pyramid[r][c].rank);
                }
            }
        }
        let positions = [0,1,2,4,5];
        for (let idx = 0; idx < state.numPlayers; idx++) {
            let i = positions[idx] !== undefined ? positions[idx] : idx;
            html += `<div class="player-area player${i}">`;
            html += `<div class="player-label">${playerNames[idx] || ("Játékos " + (idx+1))}</div>`;
            html += `<div class="hand">`;
            let hand = state.hands[idx];
            let row = state.pyramid[state.currentRow];
            let currCard = row[state.currentCard];
            hand.forEach((card, j) => {
                // Színezés: azokat a lapokat színezzük ki, amiknek a rank-je már szerepel a piramisban
                let highlight = usedRanks.has(card.rank);
                let canPlay = card.rank === currCard.rank &&
                              state.currentRow < state.pyramid.length &&
                              state.currentCard < row.length;
                let used = highlight;
                html += `<span class="card${canPlay ? " active" : ""}${used ? " used" : ""}" 
                    onclick="${canPlay && !used ? `playPyramidCard(${idx},${j})` : ""}">${printCard(card)}</span>`;
            });
            html += `</div></div>`;
        }
    }

    if (state.buszActive) {
        let pIdx = state.busPlayers[state.buszIndex];
        let busName = playerNames[pIdx] || ("Játékos " + (pIdx+1));
        html += `<div class="busz-area">
            <div class="info">${busName} buszra száll!</div>
            <div class="busz-row">`;
        state.buszCards.forEach((card, i) => {
            let highlight = (i === state.buszStep);
            html += `<div class="card${highlight ? " active" : ""}">${printCard(card)}</div>`;
        });
        html += `</div>`;
        if (state.buszStep < 5) {
            html += `<div class="busz-btns">
                <button class="btn" onclick="buszGuess('m')">Magasabb</button>
                <button class="btn" onclick="buszGuess('a')">Alacsonyabb</button>
                <button class="btn" onclick="buszGuess('u')">Ugyanolyan</button>
            </div>`;
            html += `<div class="busz-next">Mi lesz a következő kártya?</div>`;
        }
        if (state.buszNextDraw) {
            html += `<div class="busz-next">Húzott lap: ${printCard(state.buszNextDraw)}</div>`;
        }
        html += `</div>`;
    }

    tableDiv.innerHTML = html;
    infoDiv.innerHTML = state.info;
}
window.playPyramidCard = playPyramidCard;
window.nextPyramidCard = nextPyramidCard;
window.startGame = startGame;
window.buszGuess = buszGuess;
window.startBusz = startBusz;
</script>   
</body>
</html>
